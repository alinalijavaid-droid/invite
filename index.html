<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Ghoulish Gala! | Alina's 11th Birthday!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Eater&family=Mystery+Quest&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #0d051c;
            color: #fff;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; text-align: center; padding: 1rem;
            transition: opacity 1s ease-out, transform 1s ease-out;
            z-index: 10;
             overflow-y: auto;
        }
        .screen.hidden { opacity: 0; transform: translateY(100%); pointer-events: none; z-index: 1; }

        .pro-font {
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 1px #000, 0 1px 3px #000;
        }
        .floating-ghost, .flying-bat {
            position: absolute;
            opacity: 0.8;
            pointer-events: none;
            z-index: 5;
        }
        .floating-ghost { animation: float 10s ease-in-out infinite; }
        .flying-bat { animation: fly 8s linear infinite; }
        @keyframes float { 50% { transform: translateY(-20px); } }
        @keyframes fly { 50% { transform: translate(15px, -15px) scale(1.1); } }

        #grand-title-screen { background: url("https://i.ibb.co/5hTY8vVT/halloween-background-yqfav572bob9eeka.jpg") no-repeat center center; background-size: cover; }
        .main-title {
            font-family: 'Eater', cursive;
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            line-height: 1.1;
        }
        .sub-title {
            font-family: 'Creepster', cursive;
            font-size: clamp(2rem, 6vw, 3rem);
            margin-top: 1rem;
        }

        .fun-button {
            font-family: 'Creepster', cursive;
            font-size: 1.25rem;
            letter-spacing: 2px;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(45deg, #ff4e00, #ff8c00);
            color: #fff;
            border-radius: 50px; cursor: pointer; border: 2px solid #ff8c00;
            box-shadow: 0 0 10px #ff4e00, inset 0 0 5px #ff8c00;
            margin-top: 1rem;
            text-shadow: 0 0 5px #000;
            transition: all 0.3s ease;
             display: inline-block;
             min-width: 180px;
        }
        .fun-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 0 10px #ff4e00, inset 0 0 5px #ff8c00;
        }

        @media (min-width: 640px) {
            .fun-button {
                font-size: 1.5rem;
                padding: 1rem 2.5rem;
                 margin-top: 2rem;
                 min-width: 220px;
            }
        }
        .fun-button:hover:not(:disabled) {
            transform: scale(1.1) rotate(-5deg);
            box-shadow: 0 0 15px #ff4e00, 0 0 5px #ff8c00, inset 0 0 5px #ff8c00;
        }

        #warning-screen { background: url('https://i.ibb.co/7xyGvPSx/avatars-8.jpg') no-repeat center center; background-size: cover; }
        .quote-text {
            font-family: 'Mystery Quest', cursive;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            max-width: 600px;
            margin-top: 1.5rem;
        }
        .quote-loading-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
        }

        .gatekeeper-card {
            background: #1a0c2e;
            border: 4px solid #00f6ff;
            box-shadow: 0 0 15px #00f6ff;
            border-radius: 20px;
            padding: 1.5rem;
            width: calc(100% - 2rem);
            max-width: 500px;
        }
        @media (min-width: 640px) {
            .gatekeeper-card {
                padding: 2rem;
            }
        }

        .riddle-prompt-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
        }
        .riddle-text {
             font-family: 'Mystery Quest', cursive;
            font-size: 1.25rem;
            margin-top: 1rem;
        }
         @media (min-width: 640px) {
            .riddle-text {
                font-size: 1.5rem;
            }
        }
        .fun-input {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            background: #1a0c2e; border: 2px solid #00f6ff;
            color: #00f6ff; text-align: center; border-radius: 10px;
            padding: 0.5rem; transition: all 0.3s;
            box-shadow: 0 0 5px #00f6ff;
        }
        .fun-input::placeholder { color: #00f6ff; opacity: 0.6; }
        .fun-input:focus {
            box-shadow: 0 0 10px #00f6ff;
            outline: none;
        }
        .avatar-image {
            width: 120px; height: 120px;
            margin: auto; object-fit: cover;
            border-radius: 50%; border: 4px solid #00f6ff;
            box-shadow: 0 0 10px #00f6ff;
            transition: transform 0.3s;
        }
        @media (min-width: 640px) {
            .avatar-image {
                width: 150px; height: 150px;
            }
        }
        .avatar-image:hover { transform: scale(1.1); }

        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(0, 246, 255, 0.3);
            border-top-color: #00f6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #success-screen, #consolation-screen { background: url('https://i.ibb.co/1JtxRp6k/81-Ctw-Oy-Tur-L-UF1000-1000-QL80.jpg') no-repeat center center; background-size: cover; }
        .result-card {
            background: rgba(13, 5, 28, 0.85);
            border: 5px solid; border-image-slice: 1;
            border-radius: 20px;
            padding: 1.5rem;
            width: calc(100% - 2rem);
            max-width: 600px;
        }
        @media (min-width: 640px) {
            .result-card {
                padding: 2rem;
            }
        }

        #success-screen .result-card { border-image-source: linear-gradient(45deg, #39ff14, #00f6ff); }
        #consolation-screen .result-card { border-image-source: linear-gradient(45deg, #ff4e00, #ff0000); }

        .result-title {
            font-family: 'Eater', cursive;
            font-size: clamp(2rem, 6vw, 3rem);
            line-height: 1.1;
            margin-bottom: 1rem;
        }

        .result-card .text-lg {
             font-size: clamp(1rem, 3vw, 1.125rem);
        }

        .welcome-message {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(1.25rem, 5vw, 1.5rem);
            margin-bottom: 1rem;
        }

        .birthday-message {
            font-family: 'Eater', cursive;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 1rem;
        }

        .final-details p {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            line-height: 1.4;
        }
        @media (min-width: 640px) {
            .final-details p {
                font-size: 1.1rem;
            }
        }

        .detail-title {
            font-family: 'Creepster', cursive;
            letter-spacing: 1px;
            font-size: clamp(1.25rem, 5vw, 1.5rem);
            display: block;
            margin-bottom: 0.25rem;
        }
        @media (min-width: 640px) {
            .detail-title {
                display: inline;
                margin-bottom: 0;
                margin-right: 0.5rem;
            }
        }
        .gift-idea-box, .poem-box, .wish-box { /* Removed .game-output */
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
            font-size: 0.9rem;
        }

        /* --- REMOVED Styles for Guess the Word Game --- */

    </style>
</head>
<body class="pro-font">
    <img src="https://i.ibb.co/jP7hf0KQ/hd-cartoon-halloween-ghost-scary-face-png-701751694865374drzx90dpmq-removebg-preview.png" class="floating-ghost" style="width: 80px; top: 10%; left: 5%;" alt="Ghost">
    <img src="https://i.ibb.co/bTfdh0b/pngtree-bat-wings-clipart-white-background-with-a-cute-cartoon-bat-vector-png-image-6867852.png" style="width: 60px; top: 20%; right: 10%; animation-delay: -2s;" alt="Bat">
    <img src="https://i.ibb.co/mCVqXJKb/pngtree-happy-bat-cartoon-png-image-16894267.png" class="flying-bat" style="width: 50px; top: 70%; left: 15%; animation-delay: -5s;" alt="Bat">

    <div id="grand-title-screen" class="screen">
        <h1 class="main-title pro-font">A Monstrously Marvelous Ghoulish Gala</h1>
        <h2 class="sub-title pro-font">You're Summoned to Alina's 11th Birthday Bash!</h2>
        <button class="fun-button pro-font" onclick="showWarningScreen()">Enter if you Dare!</button>
    </div>

    <div id="warning-screen" class="screen hidden">
        <div id="quote-loading-box">
            <div class="spinner mx-auto" style="border-top-color: #f000ff;"></div>
            <p class="quote-loading-text pro-font mt-4">Summoning a spirit's words...</p>
        </div>
        <div id="quote-content-box" class="hidden">
            <p id="quote-text-display" class="quote-text pro-font">"When witches go riding, and black cats are seen, the moon laughs and whispers, 'tis near Halloween!"</p>
        </div>
        <button class="fun-button pro-font" onclick="showRiddleScreen()">Solve The Riddle to prove you are worthy!</button>
    </div>

    <div id="gatekeeper-screen" class="screen hidden">
        <div class="gatekeeper-card">
            <img id="avatar-image" class="avatar-image mb-4" src="https://i.ibb.co/QFHZnXDj/unnamed-2.jpg" alt="Alina's Spooky Avatar">
            <div id="riddle-loading-box">
                <div class="spinner mx-auto"></div>
                <p class="riddle-prompt-text pro-font mb-2">Summoning a spirit...</p>
            </div>
            <div id="riddle-content-box" class="hidden">
                <p id="riddle-prompt-text" class="riddle-prompt-text pro-font mb-2">A spirit appears and speaks:</p>
                <p id="riddle-text" class="riddle-text pro-font mb-4">"I am a test..."</p>
            </div>
            <div class="space-y-4 mt-4">
                <input id="guest-name" type="text" class="fun-input pro-font w-full" placeholder="What name shall I inscribe?">
                <input id="riddle-answer" type="text" class="fun-input pro-font w-full" placeholder="Your cryptic answer, if you dare...">
                <input id="guest-relation" type="text" class="fun-input pro-font w-full" placeholder="Your connection to the Birthday Spectre?">
            </div>
            <p id="error-message" class="text-red-400 text-sm mt-3 hidden"></p>
            <button id="gatekeeper-button" class="fun-button pro-font mt-6" onclick="checkRiddleAndDetails()">Unveil Your Fate!</button>
        </div>
    </div>

    <div id="success-screen" class="screen hidden">
        <div class="result-card">
            <h2 id="success-guest-name" class="welcome-message pro-font mb-2"></h2>
            <h1 class="result-title success pro-font">You are Truly Worthy!</h1>
            <p class="text-lg text-gray-200 mb-4 pro-font">Your wisdom has shone through the darkest of riddles!</p>

            <h3 class="birthday-message pro-font">Happy 11th Birthday, Alina!</h3>

            <div class="final-details text-left space-y-3 mt-6 border-t-2 border-green-400 pt-4">
                <p class="pro-font"><span class="detail-title text-green-400">The Haunting Hour:</span> Friday, Oct 31st | 2:00 PM to 6:00 PM</p>
                <p class="pro-font"><span class="detail-title text-cyan-400">The Spooky Spot:</span> House 333, Block G-3  (Our Home)<a href="https://maps.app.goo.gl/f1piNTxQnAR3kEAa9">
                <img src="https://i.ibb.co/B2LKb5SF/images-1-removebg-preview.png" alt="W3Schools.com" width="100" height="132">
            </a></p>
                <p class="pro-font"><span class="detail-title text-yellow-400">Ghastly Garb:</span> Your Most Magical Costume! Brown, Grey, White</p>
            </div>
            <p class="mt-4 text-yellow-300 pro-font">Prepare for birthday cake, spooky games, and fang-tastic treats!</p>

            <button id="gift-idea-btn-success" class="fun-button pro-font mt-4" style="background: linear-gradient(45deg, #00f6ff, #39ff14); border-color: #39ff14; box-shadow: none;" onclick="getGiftIdeas('success-gift-box')">✨ Get Gift Ideas ✨</button>
            <button id="poem-btn-success" class="fun-button pro-font mt-4" style="background: linear-gradient(45deg, #a855f7, #f000ff); border-color: #a855f7; box-shadow: none;" onclick="getBirthdayPoem('success-poem-box')">✨ Create a Birthday Verse ✨</button>
            <button id="wish-btn-success" class="fun-button pro-font mt-4" style="background: linear-gradient(45deg, #ff8c00, #fde047); border-color: #fde047; box-shadow: none;" onclick="getBirthdayWish('success-wish-box')">✨ Craft a Spooky Birthday Wish ✨</button>
            <!-- REMOVED Game Button -->

            <div id="success-gift-box" class="gift-idea-box hidden pro-font"></div>
            <div id="success-poem-box" class="poem-box hidden pro-font"></div>
            <div id="success-wish-box" class="wish-box hidden pro-font"></div>
        </div>
    </div>

    <div id="consolation-screen" class="screen hidden">
        <div class="result-card">
            <h2 id="consolation-guest-name" class="welcome-message pro-font mb-2"></h2>
            <h1 class="result-title consolation pro-font">The Riddle Remains a Mystery...</h1>
            <p class="text-lg text-gray-200 mb-2 pro-font">The correct answer was: <span id="correct-riddle-answer" class="font-bold text-yellow-400"></span></p>
            <p class="text-lg text-gray-200 mb-4 pro-font">But fear not! It's Alina's special day, and she compels us to still invite you to her:</p>

            <h3 class="birthday-message pro-font">Happy 11th Birthday, Alina!</h3>

            <div class="final-details text-left space-y-3 mt-6 border-t-2 border-orange-400 pt-4">
                <p class="pro-font"><span class="detail-title text-green-400">The Haunting Hour:</span> Friday, Oct 31st | 2:00 PM to 6:00 PM</p>
                <p class="pro-font"><span class="detail-title text-cyan-400">The Spooky Spot:</span> House 333, Block G-3 Juhar town (Our Home) 
               <center> <h1>Follow the Map</h1><a href="https://maps.app.goo.gl/f1piNTxQnAR3kEAa9">
                <img src="https://i.ibb.co/B2LKb5SF/images-1-removebg-preview.png" alt="W3Schools.com" width="50" height="50"> </a></p>
            </a>  </p></center>
                <p class="pro-font"><span class="detail-title text-yellow-400">Ghastly Garb:</span> Your Most Magical Costume! Brown, Grey, White!</p>
            </div>
            <p class="mt-4 text-orange-300 pro-font">Prepare for birthday cake, spooky games, and fang-tastic treats!</p>

            <button id="gift-idea-btn-consolation" class="fun-button pro-font mt-4" style="background: linear-gradient(45deg, #00f6ff, #39ff14); border-color: #39ff14; box-shadow: none;" onclick="getGiftIdeas('consolation-gift-box')">✨ Get Gift Ideas ✨</button>
            <button id="poem-btn-consolation" class="fun-button pro-font mt-4" style="background: linear-gradient(45deg, #a855f7, #f000ff); border-color: #a855f7; box-shadow: none;" onclick="getBirthdayPoem('consolation-poem-box')">✨ Create a Birthday Verse ✨</button>
            <button id="wish-btn-consolation" class="fun-button pro-font mt-4" style="background: linear-gradient(45deg, #ff8c00, #fde047); border-color: #fde047; box-shadow: none;" onclick="getBirthdayWish('consolation-wish-box')">✨ Craft a Spooky Birthday Wish ✨</button>
            <!-- REMOVED Game Button -->

            <div id="consolation-gift-box" class="gift-idea-box hidden pro-font"></div>
            <div id="consolation-poem-box" class="poem-box hidden pro-font"></div>
            <div id="consolation-wish-box" class="wish-box hidden pro-font"></div>
            <center>
                <h1>Play Game</h1>

                <p><a href="https://gemini.google.com/share/c8f73d076319">
                <img src="https://i.ibb.co/C31yYGn4/5260498.png" alt="W3Schools.com" width="100" height="132">
        </a></p> </center>
        </div>
    </div>

    <!-- REMOVED Screen 5: Guess The Word Game -->


    <audio id="swoosh-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_73ed201763.mp3" preload="auto"></audio>
    <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/03/10/audio_c3b04c7c6a.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="https://cdn.pixabay.com/audio/2022/03/14/audio_90c10b7f6c.mp3" preload="auto"></audio>
    <audio id="bg-music" src="https://cdn.pixabay.com/audio/2022/10/26/audio_a7a2a85a32.mp3" loop preload="auto"></audio>

    <script>
        // --- ✨ PASTE YOUR API KEY HERE ✨ ---
        const apiKey = "AIzaSyA41Znf1GTroZTXTe3UqyyqARNzMSgjQzg"; // <-- PASTE YOUR SECRET API KEY BETWEEN THE QUOTES
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- Screen Elements ---
        const grandTitleScreen = document.getElementById('grand-title-screen');
        const warningScreen = document.getElementById('warning-screen');
        const gatekeeperScreen = document.getElementById('gatekeeper-screen');
        const successScreen = document.getElementById('success-screen');
        const consolationScreen = document.getElementById('consolation-screen');
        // REMOVED: const gameScreen = document.getElementById('game-screen');

        const quoteLoadingBox = document.getElementById('quote-loading-box');
        const quoteContentBox = document.getElementById('quote-content-box');
        const quoteTextDisplay = document.getElementById('quote-text-display');

        const errorMessage = document.getElementById('error-message');
        const avatarImage = document.getElementById('avatar-image');
        const riddleLoadingBox = document.getElementById('riddle-loading-box');
        const riddleContentBox = document.getElementById('riddle-content-box');
        const riddleText = document.getElementById('riddle-text');
        const guestNameInput = document.getElementById('guest-name');
        const riddleAnswerInput = document.getElementById('riddle-answer');
        const guestRelationInput = document.getElementById('guest-relation');
        const gatekeeperButton = document.getElementById('gatekeeper-button');

        const successGuestName = document.getElementById('success-guest-name');
        const consolationGuestName = document.getElementById('consolation-guest-name');
        const correctRiddleAnswerSpan = document.getElementById('correct-riddle-answer');

        // --- REMOVED: Guess The Word Game Elements ---

        // --- Audio Elements ---
        const swooshSound = document.getElementById('swoosh-sound');
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');
        const bgMusic = document.getElementById('bg-music');

        const avatarProfiles = [
             { persona: 'A glamorous skeleton who loves glitter and rock music.', src: 'https://i.ibb.co/tpTnfCpd/unnamed.jpg' },
             { persona: 'A futuristic alien princess who is obsessed with Earth candy.', src: 'https://i.ibb.co/WWYqY29C/unnamed-3.jpg' },
             { persona: 'A classic, bubbly witch who loves to brew potions that smell like bubblegum.', src: 'https://i.ibb.co/GvdNZy6B/unnamed-1.jpg' },
             { persona: 'A slightly mad scientist who is very proud of her bubbling, glowing experiments.', src: 'https://i.ibb.co/R42GNSdx/avatars-7.jpg' },
             { persona: 'A high-energy ghost cheerleader with a spectral pom-pom.', src: 'https://i.ibb.co/7tCTkSMq/unnamed-6.jpg' },
             { persona: 'A cool werewolf rocker with a guitar made of bones.', src: 'https://i.ibb.co/d03MTvWv/unnamed-7.jpg' },
             { persona: 'A second classic, bubbly witch who also loves to brew potions.', src: 'https://i.ibb.co/GvdNZy6B/unnamed-1.jpg' },
             { persona: 'A very sleepy, moody vampire who is doing this as a favor to Alina.', src: 'https://i.ibb.co/QFHZnXDj/unnamed-2.jpg' }
        ];

        let currentAvatarRiddleIndex = Math.floor(Math.random() * avatarProfiles.length);
        let currentGeneratedRiddle = { riddle: "", answer: "" };
        let welcomeMessageLoading = false;
        let giftIdeasLoading = false;
        let poemLoading = false;
        let wishLoading = false;

        let globalGuestName = "";
        let globalGuestRelation = "";

        // --- REMOVED: Guess The Word Game State ---
        let lastScreenBeforeGame = 'success'; // Kept variable, but game functions removed

        // --- Gemini API Helper Functions ---
        function exponentialBackoff(fn, retries = 3, delay = 1000) {
            return new Promise((resolve, reject) => {
                async function retry() {
                    try { const res = await fn(); resolve(res); }
                    catch (err) {
                        if (retries > 0) { setTimeout(retry, delay); retries--; delay *= 2; }
                        else { reject(err); }
                    }
                }
                retry();
            });
        }

        async function callGemini(prompt, isJsonResponse = false) {
             if (apiKey === "" || apiKey.includes("PASTE") || apiKey.includes("YOUR")) {
                console.error("API Key is missing or is a placeholder!");
                showApiError("API Key is missing. Cannot use AI features.");
                throw new Error("API Key is missing or invalid.");
             }

             const payload = { contents: [{ parts: [{ text: prompt }] }] };
             if (isJsonResponse) {
                 payload.generationConfig = { responseMimeType: "application/json" };
             }

             const apiCall = () => fetch(GEMINI_API_URL, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });

             try {
                 const response = await exponentialBackoff(apiCall);
                 if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Google API Error:", response.status, errorBody);
                    let userMessage = `API Error (${response.status}).`;
                    if (response.status === 400) userMessage += " Check API Key/Request.";
                    if (response.status === 429) userMessage += " Rate limit exceeded.";
                    showApiError(userMessage);
                    throw new Error(`API Error: ${response.status}. Details: ${errorBody}`);
                 }
                 const result = await response.json();

                 if (!result.candidates || !result.candidates[0]?.content?.parts[0]?.text) {
                     if (result.promptFeedback?.blockReason) {
                         console.error("Gemini call blocked:", result.promptFeedback.blockReason);
                         showApiError(`API call blocked: ${result.promptFeedback.blockReason}`);
                         throw new Error(`API call blocked due to: ${result.promptFeedback.blockReason}`);
                     }
                     console.error("Invalid response structure:", JSON.stringify(result, null, 2));
                     showApiError("Invalid response from API.");
                     throw new Error("Invalid response structure from Gemini API");
                 }

                 return result.candidates[0].content.parts[0].text;
             } catch (error) {
                 if (!error.message.startsWith("API call blocked") && !error.message.startsWith("API Error")) {
                    showApiError("Network error or API unavailable.");
                 }
                 throw error;
             }
        }

        function showApiError(message) {
            if (errorMessage && gatekeeperScreen && !gatekeeperScreen.classList.contains('hidden')) {
                errorMessage.textContent = `⚠️ ${message}`;
                errorMessage.classList.remove('hidden');
            }
             const giftBoxSuccess = document.getElementById('success-gift-box');
             if (giftBoxSuccess && !giftBoxSuccess.classList.contains('hidden') && giftIdeasLoading) {
                 giftBoxSuccess.innerHTML = `<p class="text-red-500 pro-font">⚠️ ${message}</p>`;
             }
             const poemBoxSuccess = document.getElementById('success-poem-box');
             if (poemBoxSuccess && !poemBoxSuccess.classList.contains('hidden') && poemLoading) {
                 poemBoxSuccess.innerHTML = `<p class="text-red-500 pro-font">⚠️ ${message}</p>`;
             }
             const wishBoxSuccess = document.getElementById('success-wish-box');
             if (wishBoxSuccess && !wishBoxSuccess.classList.contains('hidden') && wishLoading) {
                 wishBoxSuccess.innerHTML = `<p class="text-red-500 pro-font">⚠️ ${message}</p>`;
             }
             const giftBoxCons = document.getElementById('consolation-gift-box');
              if (giftBoxCons && !giftBoxCons.classList.contains('hidden') && giftIdeasLoading) {
                 giftBoxCons.innerHTML = `<p class="text-red-500 pro-font">⚠️ ${message}</p>`;
             }
             const poemBoxCons = document.getElementById('consolation-poem-box');
             if (poemBoxCons && !poemBoxCons.classList.contains('hidden') && poemLoading) {
                 poemBoxCons.innerHTML = `<p class="text-red-500 pro-font">⚠️ ${message}</p>`;
             }
             const wishBoxCons = document.getElementById('consolation-wish-box');
              if (wishBoxCons && !wishBoxCons.classList.contains('hidden') && wishLoading) {
                 wishBoxCons.innerHTML = `<p class="text-red-500 pro-font">⚠️ ${message}</p>`;
             }
             console.error("API Error Displayed:", message);
        }


        async function generateSpookyQuote() {
            quoteLoadingBox.classList.remove('hidden');
            quoteContentBox.classList.add('hidden');
            const prompt = `You are a spooky spirit. Generate one single, classic-style, spooky Halloween quote. It should be one sentence long. Return ONLY the quote as a single string.`;
            try {
                let text = await callGemini(prompt);
                quoteTextDisplay.textContent = text.replace(/\"/g, '');
            } catch (error) {
                quoteTextDisplay.textContent = `"When witches go riding..."`;
            } finally {
                quoteLoadingBox.classList.add('hidden');
                quoteContentBox.classList.remove('hidden');
            }
        }

        async function generateDynamicRiddle(persona) {
            gatekeeperButton.disabled = true;
            riddleLoadingBox.classList.remove('hidden');
            riddleContentBox.classList.add('hidden');
            const prompt = `Create a classic, one-sentence riddle and its simple, one or two-word answer, spoken by a character with persona: "${persona}". Return ONLY a JSON object: {"riddle": "Your riddle", "answer": "Your answer"}`;
            try {
                const jsonText = await callGemini(prompt, true);
                const parsed = JSON.parse(jsonText);
                currentGeneratedRiddle = { riddle: parsed.riddle, answer: parsed.answer.toLowerCase().trim() };
                riddleText.textContent = `"${currentGeneratedRiddle.riddle}"`;
            } catch (error) {
                currentGeneratedRiddle = { riddle: "I have cities, but no houses...?", answer: "a map" };
                riddleText.textContent = `"${currentGeneratedRiddle.riddle}"`;
            } finally {
                gatekeeperButton.disabled = false;
                riddleLoadingBox.classList.add('hidden');
                riddleContentBox.classList.remove('hidden');
            }
        }

        async function getGiftIdeas(targetBoxId) {
             if (giftIdeasLoading) return; giftIdeasLoading = true;
             const targetBox = document.getElementById(targetBoxId);
             targetBox.classList.remove('hidden');
             targetBox.innerHTML = '<div class="spinner mx-auto"></div><p class="pro-font">Brewing ideas...</p>';
             const prompt = `Suggest 4-5 fun birthday gift ideas for girls 11-15, easy to find (bookstores, toy stores, markets). Start with 'Here are a few great ideas...' Use bullet points.`;
             try {
                 let text = await callGemini(prompt);
                 text = text.replace(/\n/g, '<br>').replace(/\* /g, '<br>• ');
                 targetBox.innerHTML = text;
             } catch (error) {
                 targetBox.innerHTML = "<p class='text-red-400 pro-font'>The spirits are stumped!</p>";
             } finally {
                 giftIdeasLoading = false;
                 const button = document.getElementById(targetBoxId.replace('-box', '-btn'));
                 if (button) button.classList.add('hidden');
             }
        }

        async function generateWelcomeMessage(guestName, guestRelation, targetElement) {
            if (!targetElement) {
                console.error("Target element for welcome message is missing!");
                return;
            }
            welcomeMessageLoading = true;
            targetElement.textContent = `Conjuring a welcome for ${guestName}...`;
            const prompt = `You are a spooky gatekeeper for Alina's 11th Halloween birthday. Guest: "${guestName}" (${guestRelation}). Write a short, single-sentence, spooky but fun welcome. No exclamation points.`;
            try {
                let text = await callGemini(prompt);
                targetElement.textContent = text.replace(/\"/g, '');
            } catch (error) {
                targetElement.textContent = `Welcome, ${guestName}!`;
            } finally {
                welcomeMessageLoading = false;
            }
        }


        async function getBirthdayPoem(targetBoxId) {
            if (poemLoading) return; poemLoading = true;
            const targetBox = document.getElementById(targetBoxId);
             if (!targetBox) { console.error("Target box for poem missing:", targetBoxId); poemLoading = false; return; }
            targetBox.classList.remove('hidden');
            targetBox.innerHTML = '<div class="spinner mx-auto"></div><p class="pro-font">Writing a verse...</p>';
            const prompt = `You are a fun, spooky poet. Guest: "${globalGuestName}" (Alina's "${globalGuestRelation}"). Write a short, 4-line birthday poem for Alina (11th birthday on Halloween). Celebratory, spooky, fun. Start with 'Here is a special verse for Alina from ${globalGuestName}...'`;
            try {
                let text = await callGemini(prompt);
                text = text.replace(/\n/g, '<br>');
                targetBox.innerHTML = text;
            } catch (error) {
                 targetBox.innerHTML = "<p class='text-red-400 pro-font'>The poet's ghost got shy!</p>";
            } finally {
                poemLoading = false;
                 const button = document.getElementById(targetBoxId.replace('-box', '-btn'));
                 if (button) button.classList.add('hidden');
            }
        }

        async function getBirthdayWish(targetBoxId) {
            if (wishLoading) return; wishLoading = true;
            const targetBox = document.getElementById(targetBoxId);
            if (!targetBox) { console.error("Target box for wish missing:", targetBoxId); wishLoading = false; return; }
            targetBox.classList.remove('hidden');
            targetBox.innerHTML = '<div class="spinner mx-auto"></div><p class="pro-font">Conjuring a wish...</p>';
            const prompt = `You are a fun, spooky character. Guest: "${globalGuestName}" (Alina's "${globalGuestRelation}"). Write a unique, 2-3 sentence birthday wish for Alina (11th birthday on Halloween). Celebratory, spooky, fun. Start with 'A spooky birthday wish flies your way from ${globalGuestName}...'`;
            try {
                let text = await callGemini(prompt);
                text = text.replace(/\n/g, '<br>');
                targetBox.innerHTML = text;
            } catch (error) {
                 targetBox.innerHTML = "<p class='text-red-400 pro-font'>The wish-granting ghoul is busy!</p>";
            } finally {
                wishLoading = false;
                 const button = document.getElementById(targetBoxId.replace('-box', '-btn'));
                 if (button) button.classList.add('hidden');
            }
        }

        // --- REMOVED: Guess The Word Game Functions ---

        // --- REMOVED startGame function ---

        // --- REMOVED returnToInvitation function ---

        function playSound(audioElement) {
             try {
                 if (audioElement && typeof audioElement.play === 'function') {
                     audioElement.play().catch(e => console.warn("Audio play error:", e));
                 }
             } catch (e) {
                 console.warn("Could not play sound:", e);
             }
        }


        function showScreen(screenToShow) {
            // REMOVED gameScreen from this list
            [grandTitleScreen, warningScreen, gatekeeperScreen, successScreen, consolationScreen].forEach(screen => {
                if (!screen) { console.warn("A screen element is missing!"); return; }
                if (screen === screenToShow) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
        }

        function showWarningScreen() {
            playSound(swooshSound);
            showScreen(warningScreen);
            generateSpookyQuote();
        }

        function showRiddleScreen() {
            playSound(swooshSound);
            showScreen(gatekeeperScreen);

            currentAvatarRiddleIndex = Math.floor(Math.random() * avatarProfiles.length);
            const selectedProfile = avatarProfiles[currentAvatarRiddleIndex];
            avatarImage.src = selectedProfile.src;

            guestNameInput.value = '';
            riddleAnswerInput.value = '';
            guestRelationInput.value = '';
            errorMessage.classList.add('hidden');

            generateDynamicRiddle(selectedProfile.persona);
        }

        async function checkRiddleAndDetails() {
            const guestName = guestNameInput.value.trim();
            const guestRiddleAnswer = riddleAnswerInput.value.toLowerCase().trim();
            const guestRelation = guestRelationInput.value.trim();
            const correctRiddleAnswer = currentGeneratedRiddle.answer;

            errorMessage.classList.add('hidden');

            if (guestName === '') {
                errorMessage.textContent = "The spirits demand to know your name!";
                errorMessage.classList.remove('hidden');
                playSound(wrongSound);
                return;
            }

            if (guestRelation === '') {
                errorMessage.textContent = "State your connection to Alina, or be forever lost!";
                errorMessage.classList.remove('hidden');
                playSound(wrongSound);
                return;
            }

            globalGuestName = guestName;
            globalGuestRelation = guestRelation;

            let targetScreen;
            let targetWelcomeElement;

            if (guestRiddleAnswer === correctRiddleAnswer) {
                playSound(correctSound);
                targetScreen = successScreen;
                targetWelcomeElement = successGuestName;
            } else {
                playSound(wrongSound);
                targetScreen = consolationScreen;
                targetWelcomeElement = consolationGuestName;
                if (correctRiddleAnswerSpan) {
                     correctRiddleAnswerSpan.textContent = `"${correctRiddleAnswer}"`;
                } else {
                    console.error("correctRiddleAnswerSpan element not found!");
                }
            }

            // Make buttons visible again on the target screen
            if (targetScreen === successScreen) {
                // REMOVED game button ID
                ['gift-idea-btn-success', 'poem-btn-success', 'wish-btn-success'].forEach(id => {
                    const btn = document.getElementById(id); if (btn) btn.classList.remove('hidden');
                });
                ['success-gift-box', 'success-poem-box', 'success-wish-box'].forEach(id => {
                    const box = document.getElementById(id); if (box) box.classList.add('hidden'); box.innerHTML = '';
                });
            } else if (targetScreen === consolationScreen) {
                // REMOVED game button ID
                 ['gift-idea-btn-consolation', 'poem-btn-consolation', 'wish-btn-consolation'].forEach(id => {
                    const btn = document.getElementById(id); if (btn) btn.classList.remove('hidden');
                });
                 ['consolation-gift-box', 'consolation-poem-box', 'consolation-wish-box'].forEach(id => {
                    const box = document.getElementById(id); if (box) box.classList.add('hidden'); box.innerHTML = '';
                });
            }

            await generateWelcomeMessage(guestName, guestRelation, targetWelcomeElement);
            showScreen(targetScreen);
            playSound(bgMusic);
        }

        document.addEventListener('DOMContentLoaded', () => {
             showScreen(grandTitleScreen);
        });

    </script>
</body>
</html>

