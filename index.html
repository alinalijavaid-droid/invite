<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alina's 11th Birthday Gala</title>
    
    <!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. Root Variables (Theme) --- */
        :root {
            /* Fonts */
            --font-body: 'Inter', sans-serif;
            --font-display: 'Great Vibes', cursive;
            
            /* Core Colors */
            --color-bg: linear-gradient(135deg, #2a004f 0%, #F25AB6 100%); 
            --color-surface: rgba(30, 30, 30, 0.75); 
            --color-text: #ffffff; 
            --color-text-dim: #e0e0e0; 
            
            /* Accent Colors */
            --color-accent: #F25AB6; 
            --color-accent-secondary: #8a2be2; 
            --color-accent-glow: rgba(242, 90, 182, 0.5); 

            /* Other */
            --border-radius: 12px;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.3);
            --shadow-strong: 0 0 25px var(--color-accent-glow);

            /* NEW Firework Colors */
            --firework-color-1: #FFD700; /* Gold */
            --firework-color-2: #8A2BE2; /* Blue Violet */
            --firework-color-3: #FF69B4; /* Hot Pink */
            --firework-color-4: #00FFFF; /* Aqua */
        }

        /* --- 2. Base Styles --- */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(138, 43, 226, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 85% 20%, rgba(217, 0, 128, 0.2) 0%, transparent 40%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.8)"/><circle cx="50" cy="60" r="0.8" fill="rgba(255,255,255,0.7)"/><circle cx="80" cy="20" r="1.2" fill="rgba(255,255,255,0.9)"/></svg>'),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><circle cx="20" cy="70" r="0.9" fill="rgba(255,255,255,0.7)"/><circle cx="90" cy="30" r="1.1" fill="rgba(255,255,255,0.8)"/></svg>'),
                var(--color-bg); 
            background-attachment: fixed;
            background-size: 150% 150%, 150% 150%, 100px 100px, 120px 120px, cover; 
            background-position: 0 0, 0 0, 0 0, 0 0, center center;
            animation: moveNebula 20s linear infinite alternate, twinkle 5s linear infinite; 
            color: var(--color-text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem; 
            overflow: hidden; 
            position: relative;
        }
        
        /* --- 3. Background Animations (Unchanged) --- */
        @keyframes moveNebula {
            0% { background-position: 0% 0%, 100% 100%, 0 0, 0 0, center center; }
            100% { background-position: 100% 100%, 0% 0%, 0 0, 0 0, center center; }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.5; }
        }

        /* --- 4. Floating Flowers & Shooting Stars --- */
        .flowers-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .flowers-container i {
            position: absolute;
            bottom: -20px;
            display: block;
            font-style: normal;
            color: rgba(255, 255, 255, 0.15);
            animation: float-up 20s linear infinite;
        }
        
        .flowers-container i:nth-child(1) { left: 10%; font-size: 20px; animation-duration: 15s; animation-delay: 0s; }
        .flowers-container i:nth-child(2) { left: 20%; font-size: 14px; animation-duration: 20s; animation-delay: 5s; }
        .flowers-container i:nth-child(3) { left: 30%; font-size: 24px; animation-duration: 18s; animation-delay: 2s; }
        .flowers-container i:nth-child(4) { left: 40%; font-size: 12px; animation-duration: 25s; animation-delay: 8s; }
        .flowers-container i:nth-child(5) { left: 50%; font-size: 18px; animation-duration: 16s; animation-delay: 3s; }
        .flowers-container i:nth-child(6) { left: 60%; font-size: 22px; animation-duration: 19s; animation-delay: 1s; }
        .flowers-container i:nth-child(7) { left: 70%; font-size: 16px; animation-duration: 22s; animation-delay: 6s; }
        .flowers-container i:nth-child(8) { left: 80%; font-size: 14px; animation-duration: 24s; animation-delay: 4s; }
        .flowers-container i:nth-child(9) { left: 90%; font-size: 20px; animation-duration: 17s; animation-delay: 7s; }
        .flowers-container i:nth-child(10) { left: 55%; font-size: 16px; animation-duration: 21s; animation-delay: 9s; }

        @keyframes float-up {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.1; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0.3; }
        }
        
        .shooting-stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
            transform: rotate(20deg);
        }
        
        .shooting-star {
            position: absolute;
            height: 2px;
            background: linear-gradient(-45deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
            border-radius: 999px;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.8));
            animation: shoot 5s linear infinite;
        }
        
        .shooting-star:nth-child(1) { top: 10%; left: -100%; width: 200px; animation-delay: 0s; animation-duration: 4s; }
        .shooting-star:nth-child(2) { top: 30%; left: -100%; width: 120px; animation-delay: 1.5s; animation-duration: 5s; }
        .shooting-star:nth-child(3) { top: 60%; left: -100%; width: 250px; animation-delay: 3s; animation-duration: 3.5s; }
        .shooting-star:nth-child(4) { top: 40%; left: -100%; width: 180px; animation-delay: 0.5s; animation-duration: 3s; }
        .shooting-star:nth-child(5) { top: 75%; left: -100%; width: 100px; animation-delay: 2.5s; animation-duration: 5.5s; }
        .shooting-star:nth-child(6) { top: 20%; left: -100%; width: 300px; animation-delay: 4s; animation-duration: 3s; } 


        @keyframes shoot {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(150vw); opacity: 0; }
        }

        /* --- REVISED: Fireworks --- */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .firework {
            position: absolute;
            transform: translate(-50%, -50%); /* Center based on its own size */
            opacity: 0;
            animation: firework-launch 5s infinite; /* Initial launch animation */
            border-radius: 50%; /* Start as a dot */
            filter: blur(0.5px); /* Soften the edges */
        }
        
        .firework::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0;
            animation: firework-burst 0.8s ease-out forwards; /* Burst animation */
            animation-delay: var(--burst-delay); /* Controlled by JS */
            background-image: radial-gradient(circle, var(--firework-color) 10%, transparent 70%);
            width: var(--firework-size);
            height: var(--firework-size);
        }

        /* Keyframes for firework launch */
        @keyframes firework-launch {
            0% { opacity: 0; transform: translate(var(--start-x), var(--start-y)) scale(0.2); }
            5% { opacity: 1; transform: translate(var(--start-x), var(--launch-peak-y)) scale(0.5); }
            10% { opacity: 0; transform: translate(var(--start-x), var(--launch-peak-y)) scale(0.5); } /* Disappears before burst */
            100% { opacity: 0; transform: translate(var(--start-x), var(--start-y)); }
        }

        /* Keyframes for firework burst */
        @keyframes firework-burst {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; filter: blur(3px); }
        }

        /* --- 5. Main Invitation Card --- */
        .invitation-container {
            width: 100%;
            max-width: 420px; 
            height: 85vh;
            max-height: 700px;
            min-height: 480px;
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light), 0 0 40px var(--color-accent-glow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            overflow: hidden; 
            position: relative;
            z-index: 1; 
            animation: pulse-glow 5s infinite alternate, breathe-scale 5s infinite alternate;
            display: flex;
            flex-direction: column;
        }

        /* For short screens (like landscape phones) */
        @media (max-height: 480px) {
            .invitation-container {
                min-height: 0; 
                height: 95vh; 
            }
        }

        @keyframes pulse-glow {
            from { box-shadow: var(--shadow-light), 0 0 30px var(--color-accent-glow); }
            to { box-shadow: var(--shadow-light), 0 0 50px rgba(138, 43, 226, 0.7); }
        }
        
        @keyframes breathe-scale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        /* --- 6. Page Structure & Transitions --- */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1.5rem; 
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
            overflow-y: auto; 
            padding-bottom: 3rem; 
        }
        
        .page.active { transform: translateX(0); }
        .page.left { transform: translateX(-100%); }

        #page-welcome {
            justify-content: flex-start; 
            padding-top: 3rem; 
        }


        /* --- 7. Page 1: SPLASH SCREEN --- */
        #page-splash .splash-icon {
            width: 80%;
            max-width: 280px;
            height: auto;
            margin: 0 auto 20px;
            animation: logo-pulse-glow 3s infinite alternate;
            /* REMOVED border-radius: 50% */
            /* REMOVED box-shadow: 0 5px 15px rgba(0,0,0,0.2); */
        }
        
        #page-splash .splash-icon img {
            width: 100%;
            height: auto;
            border-radius: 15px; /* RESTORED original border-radius */
            display: block; /* Remove extra space below img */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* RESTORED original box-shadow */
        }

        @keyframes logo-pulse-glow {
             from {
                filter: drop-shadow(0 0 15px var(--color-accent-glow));
                transform: scale(1);
            }
            to {
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.7));
                transform: scale(1.03);
            }
        }

        #page-splash h1 {
            font-family: var(--font-display);
            font-size: clamp(3rem, 15vw, 4rem); 
            color: white;
            margin: 0;
            text-shadow: 0 0 15px var(--color-accent-glow);
        }

        #page-splash h2 {
            font-family: var(--font-display);
            font-size: clamp(1.8rem, 8vw, 2.2rem);
            color: var(--color-accent);
            margin-top: 5px; 
            margin-bottom: 25px;
        }

        #page-splash p {
            font-size: clamp(1rem, 4.5vw, 1.2rem);
            color: var(--color-text); 
            font-weight: 500; 
            margin: 0 0 30px;
        }

        /* --- 8. Page 2: INPUT SCREEN --- */
        #page-input .logo-small {
            width: 120px; 
            height: auto;
            margin-bottom: 20px;
            animation: logo-pulse-glow 3s infinite alternate;
            /* REMOVED border-radius: 50% */
        }
        #page-input .logo-small img {
            width: 100%;
            height: auto;
            /* REMOVED border-radius: 50%; */
            /* This rule is no longer needed as the logo isn't round */
        }

        #page-input h2 {
            font-family: var(--font-display);
            font-size: clamp(2rem, 10vw, 2.5rem);
            color: white;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        #page-input p {
            font-size: clamp(1rem, 4.5vw, 1.2rem);
            color: var(--color-text); 
            font-weight: 500; 
            margin-top: 0;
            margin-bottom: 30px;
        }

        .input-group {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-text);
            font-weight: 500;
        }

        /* --- 9. Page 3: WELCOME SCREEN --- */
        #page-welcome .logo-small {
            width: 120px; 
            height: auto;
            margin-bottom: 15px;
            animation: logo-pulse-glow 3s infinite alternate;
            /* REMOVED border-radius: 50% */
        }
        #page-welcome .logo-small img {
            width: 100%;
            height: auto;
            /* REMOVED border-radius: 50%; */
            /* This rule is no longer needed */
        }

        #page-welcome h1 {
            font-family: var(--font-display);
            font-size: clamp(1.8rem, 9vw, 2.5rem);
            color: white;
            margin: 0;
            line-height: 1.3;
        }

        #page-welcome h2 {
            font-size: 1.1rem;
            color: var(--color-accent);
            margin: 10px 0;
            font-weight: 500;
            line-height: 1.4;
        }

        .party-details {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            width: 100%;
            max-width: 320px;
            box-sizing: border-box;
            margin: 20px 0;
            font-size: 1rem; 
            color: var(--color-text);
            text-align: left;
        }
        
        .party-details div {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .party-details div:last-child {
            margin-bottom: 0;
        }
        
        .party-details strong {
            display: block; 
            color: var(--color-accent); 
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .dress-code-helper {
            font-size: 0.9rem;
            color: var(--color-accent);
            text-decoration: underline;
            cursor: pointer;
            margin-left: 5px;
            font-weight: 700;
        }

        .message-box {
            width: 100%;
            max-width: 320px;
            margin-top: 20px;
        }
        
        #generated-bday-message {
            font-size: 0.95rem; 
            font-style: italic;
            color: var(--color-text); 
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem; 
            min-height: 3em;
            margin-top: 15px;
            line-height: 1.5;
            text-align: left; 
        }

        /* --- 10. Form Elements & Buttons --- */
        input[type="text"] {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-family: var(--font-body);
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-text-dim);
            border-radius: 8px;
            color: var(--color-text);
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 10px var(--color-accent-glow);
        }

        .btn {
            background-color: var(--color-accent);
            color: #121212;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 50px; 
            padding: 14px 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-strong);
            width: 100%;
            max-width: 300px; 
            flex-grow: 0; 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            flex-shrink: 0; 
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 35px var(--color-accent-glow);
        }

        /* --- 11. Loader & Error (Unchanged) --- */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        #loader.visible {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--color-text-dim);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error-message {
            color: #FF5555;
            font-weight: 500;
            margin-top: 15px;
            min-height: 1.2em;
            display: none;
            flex-shrink: 0; 
        }
        #error-message.visible {
            display: block;
        }

    </style>
</head>
<body>

    <!-- Background Flowers --><div class="flowers-container">
        <i>‚ùÄ</i> <i>‚Ä¢</i> <i>‚ùÉ</i> <i>‚Ä¢</i> <i>‚ùÄ</i> <i>‚ùÉ</i> <i>‚Ä¢</i> <i>‚ùÄ</i> <i>‚ùÉ</i> <i>‚Ä¢</i>
    </div>
    
    <!-- Shooting Stars Container --><div class="shooting-stars-container">
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
    </div>
    
    <!-- REVISED: Fireworks Container --><div class="fireworks-container" id="fireworks-container">
        <!-- Fireworks will be generated here by JavaScript --></div>


    <!-- Main Card --><div class="invitation-container">

        <!-- Page 1: Splash --><div id="page-splash" class="page active">
            <div class="splash-icon">
                <img id="alina-avatar-splash" src="https://i.ibb.co/KjvWzSSR/57c54714-cf29-48f8-a1f8-7c8c3d83933c-removebg-preview.png" alt="Alina's Logo">
            </div>
            <h1>The Gala</h1>
            <h2>A Starlight Celebration</h2>
            <p id="splash-hype-text"></p>
            <button id="splash-btn" class="btn">Enter the Gala</button>
        </div>

        <!-- Page 2: Input --><div id="page-input" class="page">
            <div class="logo-small">
                 <img id="alina-avatar-input" src="https://i.ibb.co/KjvWzSSR/57c54714-cf29-48f8-a1f8-7c8c3d83933c-removebg-preview.png" alt="Alina's Logo" >
            </div>
            <h2>A Celebration Awaits</h2>
            <p id="input-hype-text"></p>
            
            <div class="input-group">
                <label for="guest-name">Your First Name:</label>
                <input type="text" id="guest-name" placeholder="e.g., Sarah, Uncle Ben...">
            </div>
            <div class="input-group">
                <label for="guest-relation">Your Relation to Alina:</label>
                <input type="text" id="guest-relation" placeholder="e.g., Friend, Aunt, Grandparent...">
            </div>
            
            <button id="input-btn" class="btn">Check Guest List</button>
            <div id="error-message"></div> 
        </div>

        <!-- Page 3: Welcome --><div id="page-welcome" class="page">
            <div class="logo-small">
                 <img id="alina-avatar-welcome" src="https://i.ibb.co/KjvWzSSR/57c54714-cf29-48f8-a1f8-7c8c3d83933c-removebg-preview.png" alt="Alina's Logo" >
            </div>
            
            <h1 id="welcome-title"></h1>
            <h2 id="welcome-subtitle"></h2>

            <div class="party-details">
                <div><strong>Event:</strong> Alina's 11th Birthday Gala</div>
                <div><strong>Date:</strong> 31st OF OCTOBER</div>
                <div><strong>Time:</strong> 3:00 PM TO 7:00 PM</div>
                <div><strong>Location:</strong> <a href="https://maps.app.goo.gl/f1piNTxQnAR3kEAa9" style="color:#ffffff;">OUR HOME</a></div>
                <div>
                    <strong>Dress Code:</strong> Starlight Chic 
                    <span id="dress-code-btn" class="dress-code-helper">‚ú® What's this?</span>
                </div>
                <div>
                    <strong>Need a Gift Idea?</strong>
                    <span id="gift-idea-btn" class="dress-code-helper">üéÅ Get Ideas!</span>
                </div>
            </div>
            
            <div class="message-box">
                <div id="generated-bday-message">Click the helpers above for info!</div>
            </div>
        </div>

        <!-- Global Loader --><div id="loader">
            <div class="spinner"></div>
        </div>
    </div>
    
    <!-- Audio Player (Hidden) --><audio id="tts-audio-player"></audio>

    <script>
        // --- 1. API Configuration ---
        const API_KEY = "AIzaSyA41Znf1GTroZTXTe3UqyyqARNzMSgjQzg"; // Use "" for API-key-less access
        const API_URL_GENERATE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const API_URL_TTS = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

        // --- 2. DOM Selectors ---
        const pageSplash = document.getElementById('page-splash');
        const pageInput = document.getElementById('page-input');
        const pageWelcome = document.getElementById('page-welcome');
        
        const splashHypeText = document.getElementById('splash-hype-text');
        const splashBtn = document.getElementById('splash-btn');
        
        const inputHypeText = document.getElementById('input-hype-text');
        const guestNameInput = document.getElementById('guest-name');
        const guestRelationInput = document.getElementById('guest-relation');
        const inputBtn = document.getElementById('input-btn');
        const errorMessage = document.getElementById('error-message');
        
        const welcomeTitle = document.getElementById('welcome-title');
        const welcomeSubtitle = document.getElementById('welcome-subtitle');
        const dressCodeBtn = document.getElementById('dress-code-btn');
        const generatedBdayMessage = document.getElementById('generated-bday-message');
        
        const giftIdeaBtn = document.getElementById('gift-idea-btn');
        
        const loader = document.getElementById('loader');
        const audioPlayer = document.getElementById('tts-audio-player');

        // NEW: Fireworks container
        const fireworksContainer = document.getElementById('fireworks-container');
        
        // --- 3. Mock Guest List ---
        // (No actual list, just checking for empty fields)
        
        // --- 4. Core Gemini API Call (Text) ---
        async function callGemini(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are an AI assistant for Alina's 11th Birthday. Your tone is magical, exciting, and celebratory." }]
                },
            };

            const response = await fetch(API_URL_GENERATE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text.trim();
            } else {
                console.error("Invalid API response structure:", result);
                throw new Error("Failed to get valid text from API.");
            }
        }
        
        /**
         * The core Gemini TTS API call function
         */
        async function callGeminiTTS(textToSpeak) {
            const payload = {
                contents: [{
                    parts: [{ text: textToSpeak }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Leda" } 
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const response = await fetch(API_URL_TTS, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`TTS API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch && rateMatch[1] ? parseInt(rateMatch[1], 10) : 24000;
                
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                return URL.createObjectURL(wavBlob);
            } else {
                console.error("Invalid TTS response structure:", result);
                throw new Error("Invalid TTS audio data received.");
            }
        }
        
        /**
         * Converts Base64 string to ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * --- RE-INSERTED MISSING FUNCTION ---
         * Converts raw PCM16 data to a WAV file Blob.
         */
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            // 'fmt ' sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Sub-chunk size
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // Bits per sample
            // 'data' sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write PCM data
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        /**
         * --- RE-INSERTED MISSING FUNCTION ---
         * Helper to write a string to a DataView.
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * --- RE-INSERTED MISSING FUNCTION ---
         * Shows the specified page
         */
        function showPage(pageId) {
            const pages = [pageSplash, pageInput, pageWelcome];
            let activePageIndex = -1;
            
            for (let i = 0; i < pages.length; i++) {
                if (pages[i].id === pageId) {
                    activePageIndex = i;
                    break;
                }
            }

            pages.forEach((page, index) => {
                if (index === activePageIndex) {
                    page.classList.remove('left');
                    page.classList.add('active');
                } else if (index < activePageIndex) {
                    page.classList.remove('active');
                    page.classList.add('left');
                } else {
                    page.classList.remove('active', 'left');
                }
            });
        }

        /** --- RE-INSERTED MISSING FUNCTIONS --- */
        function showLoader() { loader.classList.add('visible'); }
        function hideLoader() { loader.classList.remove('visible'); }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }
        
        function hideError() {
            errorMessage.classList.remove('visible');
        }

        // --- 6. AI Generation Functions ---

        /** --- RE-INSERTED MISSING FUNCTION --- */
        async function generateSplashHype() {
            const prompt = "Generate a new, unique, bold, and dramatic 1-2 sentence message to build maximum hype for a legendary, exclusive event. DO NOT reveal what the event is or who it is for. Make it sound unforgettable, high-stakes, and incredibly exciting. Example: 'The most anticipated night of the year has arrived...' or 'What lies beyond is beyond imagination... Are you ready?'";
            try {
                const hypeText = await callGemini(prompt);
                splashHypeText.textContent = hypeText;
            } catch (error) {
                console.error("Splash hype failed:", error);
                splashHypeText.textContent = "An unforgettable night awaits...";
            }
        }
        
        /** --- RE-INSERTED MISSING FUNCTION --- */
        async function generateInputHype() {
            const prompt = "Generate a new, unique, and extremely bold 1-2 sentence message for someone who has just passed the first 'door' of an exclusive event. DO NOT reveal the event. Make it sound like a high-stakes VIP check. Focus on them 'unlocking' the next stage. Make it dramatic and mysterious. Example: 'Access granted... for now. Your identity must be verified for the main event.' or 'You''re in. But the inner circle awaits... Who are you?'";
            try {
                const hypeText = await callGemini(prompt);
                inputHypeText.textContent = hypeText;
            } catch (error) { 
                console.error("Input hype failed:", error);
                inputHypeText.textContent = "Access to the next stage is granted. Please verify your identity.";
            } 
        }

        /**
         * --- REVISED: Renamed from generateWelcome ---
         * This function ONLY generates the text and puts it on the page.
         */
        async function generateWelcomeText(name, relation) {
            // REVISED PROMPT for longer message
            const prompt = `Generate a new, unique, and very exciting welcome for a guest at Alina's 11th birthday party. The guest's name is ${name} and their relation is ${relation}.
            
            You must generate TWO things, separated by a pipe character "|":
            1.  A short, exciting welcome title (e.g., "You're In, ${name}!", "Welcome to the Gala, ${name}!", "It's really you, ${name}!")
            2.  A longer, heartfelt confirmation message (3-5 sentences). This message MUST mention their relation (e.g., "Alina's favorite ${relation}") AND express how important their presence is to Alina. Elaborate on the magical atmosphere, how thrilled Alina is, and hint at the unforgettable celebration ahead.
            
            Example format: Welcome, ${name}!|Alina's favorite ${relation} has arrived! The stars have aligned for this magical evening, and Alina couldn't be more thrilled to have you here. Your presence makes this Starlight Gala truly complete, and we're all set for an unforgettable night of celebration and wonder!
            
            Make it fun, personal, and different every time.`;

            try {
                const result = await callGemini(prompt);
                const parts = result.split('|');
                
                const title = parts[0] ? parts[0].trim() : `Welcome, ${name}!`;
                const subtitle = parts[1] ? parts[1].trim() : `Alina's favorite ${relation} is confirmed! She's so happy you're here to celebrate this magical evening with her.`;

                welcomeTitle.textContent = title;
                welcomeSubtitle.textContent = subtitle;
                
                // await generateAndPlayAudio(); // <-- THIS WAS THE ERROR, NOW REMOVED

            } catch (error) {
                console.error("Failed to generate welcome text:", error);
                welcomeTitle.textContent = `Welcome, ${name}!`;
                welcomeSubtitle.textContent = `Alina's favorite ${relation} is confirmed! She's so happy you're here.`;
                // Re-throw the error so it can be caught by the button
                throw error;
            }
        }
        
        async function generateDressCodeInfo() {
            generatedBdayMessage.innerHTML = 'Checking the stars...'; 
            const prompt = "Generate a new, unique, and fun 2-3 sentence description for a party dress code called 'Starlight Chic'. Make it sound magical, elegant, and fun for an 11-year-old's birthday gala. Mention sparkles, deep blues, purples, or silvers. Example: 'Think of the night sky! Wear your most magical, sparkling outfits. Deep blues, purples, and shimmering silvers are perfect. It's all about shining bright like a star!'";
            try {
                const info = await callGemini(prompt);
                generatedBdayMessage.innerHTML = info.replace(/\n/g, '<br>'); 
            } catch (error) {
                console.error("Failed to generate dress code:", error);
                generatedBdayMessage.innerHTML = "Wear something magical that sparkles! Think deep blues, purples, and silvers.";
            }
        }
        
        async function generateGiftIdeas() {
            generatedBdayMessage.innerHTML = 'Thinking of the perfect gift...'; 
            const prompt = "Generate 3-4 new, unique, and fun gift ideas for an 11-year-old girl's birthday. Her party theme is a 'Starlight Gala' (magical, starry, chic). She loves things that are creative, fun, and a bit magical. List the ideas clearly, maybe with emojis. Example: '‚ú® Star Projector: To turn her room into a galaxy!'";
            try {
                const info = await callGemini(prompt);
                generatedBdayMessage.innerHTML = info.replace(/\n/g, '<br>'); 
            } catch (error) {
                console.error("Failed to generate gift ideas:", error);
                generatedBdayMessage.innerHTML = "How about a cool galaxy projector, a DIY jewelry-making kit, or a fun board game?";
            }
        }
        
        async function generateAndPlayAudio() {
            const textToRead = `
                Say with excitement and warmth: ${welcomeTitle.textContent}!
                ${welcomeSubtitle.textContent}.
            `;
            
            let audioUrl;
            try {
                audioUrl = await callGeminiTTS(textToRead);
            } catch (error) {
                console.error("TTS Generation Failed:", error);
                return; 
            }

            if (!audioUrl) {
                console.error("No audio URL returned from TTS.");
                return;
            }
            
            audioPlayer.src = audioUrl;
            
            return new Promise((resolve) => { 
                audioPlayer.onended = () => {
                    URL.revokeObjectURL(audioUrl); 
                    resolve();
                };
                audioPlayer.onerror = (e) => {
                    URL.revokeObjectURL(audioUrl); 
                    console.error("Audio playback failed.", e);
                    resolve(); 
                };
                audioPlayer.play().catch(error => {
                    console.warn("Audio autoplay was blocked by the browser. This is expected behavior.");
                    resolve(); 
                });
            });
        }

        // --- NEW: Firework Generation Logic ---
        const fireworkColors = [
            'var(--firework-color-1)', 
            'var(--firework-color-2)', 
            'var(--firework-color-3)', 
            'var(--firework-color-4)'
        ];

        function createFirework() {
            const firework = document.createElement('div');
            firework.classList.add('firework');
            fireworksContainer.appendChild(firework);

            const startX = Math.random() * 100 + 'vw';
            const startY = '100vh'; // Always start from bottom
            const launchPeakY = (Math.random() * 60 + 10) + 'vh'; // Between 10% and 70% from top
            const burstDelay = (Math.random() * 1.5) + 0.5 + 's'; // Burst 0.5 to 2 seconds after launch
            const animationDuration = (Math.random() * 3) + 4 + 's'; // 4 to 7 seconds per cycle
            const fireworkSize = (Math.random() * 50 + 30) + 'px'; // 30px to 80px for burst

            const colorIndex = Math.floor(Math.random() * fireworkColors.length);
            const chosenColor = fireworkColors[colorIndex];

            firework.style.setProperty('--start-x', startX);
            firework.style.setProperty('--start-y', startY);
            firework.style.setProperty('--launch-peak-y', launchPeakY);
            firework.style.setProperty('--burst-delay', burstDelay);
            firework.style.setProperty('--firework-size', fireworkSize);
            firework.style.setProperty('--firework-color', chosenColor);
            firework.style.animationDuration = animationDuration;
            firework.style.animationDelay = (Math.random() * -animationDuration.replace('s', '')) + 's'; // Random initial offset

            firework.addEventListener('animationend', () => {
                // Relaunch the firework from a new random position
                const newStartX = Math.random() * 100 + 'vw';
                const newLaunchPeakY = (Math.random() * 60 + 10) + 'vh';
                const newBurstDelay = (Math.random() * 1.5) + 0.5 + 's';
                const newFireworkSize = (Math.random() * 50 + 30) + 'px';

                firework.style.setProperty('--start-x', newStartX);
                firework.style.setProperty('--launch-peak-y', newLaunchPeakY);
                firework.style.setProperty('--burst-delay', newBurstDelay);
                firework.style.setProperty('--firework-size', newFireworkSize);
                firework.style.animation = 'none'; // Reset animation
                void firework.offsetWidth; // Trigger reflow
                firework.style.animation = `firework-launch ${animationDuration} infinite`; // Restart animation
            });
        }

        function initFireworks(count) {
            for (let i = 0; i < count; i++) {
                createFirework();
            }
        }

        // --- 7. Event Listeners ---
        splashBtn.addEventListener('click', () => {
            showPage('page-input');
            generateInputHype();
        });
        
        /**
         * --- THIS IS THE FINAL FIX ---
         * Logic is changed to:
         * 1. Generate text (await)
         * 2. Switch page
         * 3. Play audio (no await, no loader)
         */
        inputBtn.addEventListener('click', async () => {
            hideError();
            const name = guestNameInput.value.trim();
            const relation = guestRelationInput.value.trim();
            
            if (!name || !relation) {
                showError("Please fill out both fields to join the gala!");
                return;
            }
            
            // showLoader(); // <-- REMOVED per user request
            
            try {
                // --- STEP 1: Wait ONLY for the text to be generated ---
                await generateWelcomeText(name, relation);
                
                // --- STEP 2: Switch the page ---
                showPage('page-welcome');
                
                // --- STEP 3: Play audio now that page is visible ---
                // (No 'await' here, so it plays in the background)
                generateAndPlayAudio();

            } catch (error) {
                // If text generation failed, show error
                console.error("Error during input processing:", error);
                showError("An error occurred. Please try again.");
            } 
            // 'finally' block with hideLoader() is no longer needed
        });
        
        dressCodeBtn.addEventListener('click', () => {
            generateDressCodeInfo();
        });
        
        giftIdeaBtn.addEventListener('click', () => {
            generateGiftIdeas();
        });
        
        // --- 8. Initial Load ---
        function init() {
            generateSplashHype();
            initFireworks(8); // Start 8 fireworks
        }
        
        init();

    </script>

</body>
</html>

